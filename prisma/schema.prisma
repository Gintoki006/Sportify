// Sportify — Prisma Schema
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ── Enums ──

enum SportType {
  FOOTBALL
  CRICKET
  BASKETBALL
  BADMINTON
  TENNIS
  VOLLEYBALL
}

enum StatSource {
  MANUAL
  TOURNAMENT
  STANDALONE
}

enum TournamentStatus {
  UPCOMING
  IN_PROGRESS
  COMPLETED
}

enum ClubRole {
  ADMIN
  HOST
  PARTICIPANT
  SPECTATOR
}

enum DismissalType {
  BOWLED
  CAUGHT
  LBW
  RUN_OUT
  STUMPED
  HIT_WICKET
  RETIRED
  NOT_OUT
}

enum ExtraType {
  WIDE
  NO_BALL
  BYE
  LEG_BYE
  PENALTY
}

// ── Models ──

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  name      String
  email     String   @unique
  avatarUrl String?
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sportProfiles SportProfile[]
  clubs         ClubMember[]
  adminClubs    Club[]         @relation("ClubAdmin")
  roleRequests  RoleUpgradeRequest[]
  matchesAsPlayerA Match[]    @relation("PlayerA")
  matchesAsPlayerB Match[]    @relation("PlayerB")
  createdMatches   Match[]    @relation("MatchCreator")
  tournamentPlayers TournamentPlayer[]
}

model SportProfile {
  id        String   @id @default(cuid())
  userId    String
  sportType SportType
  createdAt DateTime @default(now())

  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  stats   StatEntry[]
  goals   Goal[]

  @@unique([userId, sportType])
}

model StatEntry {
  id             String     @id @default(cuid())
  sportProfileId String
  date           DateTime   @default(now())
  opponent       String?
  notes          String?
  metrics        Json       // sport-specific metrics stored as JSON
  source         StatSource @default(MANUAL)
  matchId        String?    // if sourced from a tournament match
  createdAt      DateTime   @default(now())

  sportProfile SportProfile @relation(fields: [sportProfileId], references: [id], onDelete: Cascade)
  match        Match?       @relation(fields: [matchId], references: [id])
}

model Goal {
  id             String   @id @default(cuid())
  sportProfileId String
  metric         String   // e.g. "goals", "runs", "points_scored"
  target         Int
  current        Int      @default(0)
  deadline       DateTime?
  completed      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sportProfile SportProfile @relation(fields: [sportProfileId], references: [id], onDelete: Cascade)
}

model Club {
  id          String   @id @default(cuid())
  name        String
  description String?
  adminUserId String
  createdAt   DateTime @default(now())

  admin       User         @relation("ClubAdmin", fields: [adminUserId], references: [id])
  members     ClubMember[]
  tournaments Tournament[]
  roleRequests RoleUpgradeRequest[]
}

model ClubMember {
  id       String   @id @default(cuid())
  userId   String
  clubId   String
  role     ClubRole @default(SPECTATOR)
  joinedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([userId, clubId])
}

model RoleUpgradeRequest {
  id          String   @id @default(cuid())
  userId      String
  clubId      String
  requestedRole ClubRole
  status      RequestStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([userId, clubId, status])
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model Tournament {
  id             String           @id @default(cuid())
  clubId         String
  name           String
  sportType      SportType
  startDate      DateTime
  endDate        DateTime?
  status         TournamentStatus @default(UPCOMING)
  overs          Int?             // cricket-only: overs per innings
  playersPerSide Int?             // cricket-only: players per team
  createdAt      DateTime         @default(now())

  club    Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)
  matches Match[]
  players TournamentPlayer[]
}

model Match {
  id              String    @id @default(cuid())
  tournamentId    String?   // null for standalone matches
  round           Int       @default(0)
  teamA           String
  teamB           String
  playerAId       String?   // linked User for teamA (optional for legacy/custom names)
  playerBId       String?   // linked User for teamB (optional for legacy/custom names)
  scoreA          Int?
  scoreB          Int?
  date            DateTime?
  completed       Boolean   @default(false)
  isStandalone    Boolean   @default(false)
  sportType       SportType? // for standalone matches (tournament matches infer from tournament)
  createdByUserId String?    // who created the standalone match
  overs           Int?       // standalone cricket: overs per innings
  playersPerSide  Int?       // standalone cricket: players per team
  createdAt       DateTime  @default(now())

  tournament     Tournament?  @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerA        User?        @relation("PlayerA", fields: [playerAId], references: [id], onDelete: SetNull)
  playerB        User?        @relation("PlayerB", fields: [playerBId], references: [id], onDelete: SetNull)
  createdBy      User?        @relation("MatchCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  statEntries    StatEntry[]
  cricketInnings CricketInnings[]
}

model TournamentPlayer {
  id           String   @id @default(cuid())
  tournamentId String
  userId       String
  seed         Int      // bracket slot (0-based)
  createdAt    DateTime @default(now())

  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, userId])
  @@unique([tournamentId, seed])
}

// ── Cricket Scoring Models ──

model CricketInnings {
  id              String   @id @default(cuid())
  matchId         String
  inningsNumber   Int      // 1 = first innings, 2 = second innings
  battingTeamName String
  bowlingTeamName String
  totalRuns       Int      @default(0)
  totalWickets    Int      @default(0)
  totalOvers      Float    @default(0) // e.g. 4.3 = 4 overs 3 balls
  extras          Int      @default(0)
  isComplete      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  match          Match          @relation(fields: [matchId], references: [id], onDelete: Cascade)
  battingEntries BattingEntry[]
  bowlingEntries BowlingEntry[]
  ballEvents     BallEvent[]

  @@unique([matchId, inningsNumber])
}

model BattingEntry {
  id            String        @id @default(cuid())
  inningsId     String
  playerName    String
  playerId      String?       // linked User (optional)
  runs          Int           @default(0)
  ballsFaced    Int           @default(0)
  fours         Int           @default(0)
  sixes         Int           @default(0)
  strikeRate    Float         @default(0)
  isOut         Boolean       @default(false)
  dismissalType DismissalType?
  bowlerName    String?       // bowler who took the wicket
  bowlerId      String?
  fielderName   String?       // fielder involved (catch, run-out, stumping)
  battingOrder  Int           // position in batting order
  createdAt     DateTime      @default(now())

  innings CricketInnings @relation(fields: [inningsId], references: [id], onDelete: Cascade)
}

model BowlingEntry {
  id            String   @id @default(cuid())
  inningsId     String
  playerName    String
  playerId      String?  // linked User (optional)
  oversBowled   Float    @default(0) // e.g. 4.0
  maidens       Int      @default(0)
  runsConceded  Int      @default(0)
  wickets       Int      @default(0)
  economy       Float    @default(0)
  extras        Int      @default(0)
  noBalls       Int      @default(0)
  wides         Int      @default(0)
  bowlingOrder  Int      // order of bowling
  createdAt     DateTime @default(now())

  innings CricketInnings @relation(fields: [inningsId], references: [id], onDelete: Cascade)
}

model BallEvent {
  id            String        @id @default(cuid())
  inningsId     String
  overNumber    Int           // 1-based over number
  ballNumber    Int           // 1-based ball within over (1–6, extras may add more)
  batsmanName   String
  batsmanId     String?
  bowlerName    String
  bowlerId      String?
  runsScored    Int           @default(0) // runs off the bat
  extraType     ExtraType?
  extraRuns     Int           @default(0)
  isWicket      Boolean       @default(false)
  dismissalType DismissalType?
  commentary    String?       // auto-generated or manual commentary
  timestamp     DateTime      @default(now())

  innings CricketInnings @relation(fields: [inningsId], references: [id], onDelete: Cascade)

  @@index([inningsId, overNumber, ballNumber])
}
